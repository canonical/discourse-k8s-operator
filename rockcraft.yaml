# Copyright 2023 Canonical Ltd.
# See LICENSE file for licensing details.

name: discourse
summary: Discourse rock
description: Discourse OCI image for the Discourse charm
base: bare
build-base: ubuntu:22.04
license: Apache-2.0
version: "1.0"
platforms:
  amd64:
parts:
  add-user:
    plugin: nil
    overlay-script: |
      mkdir $CRAFT_OVERLAY/etc
      chmod 755 $CRAFT_OVERLAY/etc
      groupadd -R $CRAFT_OVERLAY --gid 2000 discourse
      useradd -R $CRAFT_OVERLAY --system --gid 2000 --uid 2000 --home /srv/discourse discourse
  get-discourse:
    plugin: dump
    source: https://github.com/discourse/discourse.git
    source-depth: 1
    source-tag: v2.8.14
    source-type: git
    organize:
      discourse: srv/discourse/app
  apply-patches:
    plugin: dump
    source: image/patches
    build-packages:
      - git
    after:
      - get-discourse
    stage:
      - srv/discourse
    override-stage: |
      craftctl default
      git -C srv/discourse/app apply image/patches/lp1903695.patch
      git -C srv/discourse/app apply image/patches/anonymize_user.patch
      rm -rf srv/patches
  #  build-assets:
    # stage-packages:
      # # - 

  # discourse:
    # build-packages:
    #  - git